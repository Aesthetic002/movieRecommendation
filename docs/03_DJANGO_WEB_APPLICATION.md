# Django Web Application Documentation

## Overview

The Django application provides a complete web interface for the movie recommendation system. It handles user authentication, movie browsing, rating submission, and displays recommendations generated by the C engine.

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          DJANGO APPLICATION                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────┐    ┌──────────────┐    ┌────────────────────────────┐ │
│  │   Templates  │◄───│    Views     │◄───│        URL Router          │ │
│  │  (Bootstrap) │    │  (Logic)     │    │    (urls.py)               │ │
│  └──────────────┘    └──────┬───────┘    └────────────────────────────┘ │
│                             │                                            │
│                             ▼                                            │
│  ┌──────────────┐    ┌──────────────┐    ┌────────────────────────────┐ │
│  │    Forms     │───→│   Models     │───→│       Database             │ │
│  │ (Validation) │    │ (ORM)        │    │   (SQLite/PostgreSQL)      │ │
│  └──────────────┘    └──────┬───────┘    └────────────────────────────┘ │
│                             │                                            │
│                             ▼                                            │
│                    ┌──────────────┐                                      │
│                    │  C Engine    │                                      │
│                    │ Integration  │                                      │
│                    └──────────────┘                                      │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Models

**Source File**: `movies/models.py`

### Movie Model

```python
class Movie(models.Model):
    """Movie model - syncs with C engine via CSV"""
    movie_id = models.IntegerField(unique=True, db_index=True)
    title = models.CharField(max_length=100)
    genre = models.CharField(max_length=50)
    year = models.IntegerField()
    poster = models.ImageField(upload_to='posters/', blank=True, null=True)
    avg_rating = models.FloatField(default=0.0)
    rating_count = models.IntegerField(default=0)
    
    class Meta:
        ordering = ['title']
    
    def __str__(self):
        return f"{self.title} ({self.year})"
```

**Fields**:
| Field | Type | Description |
|-------|------|-------------|
| `movie_id` | Integer | Unique ID for C engine sync |
| `title` | CharField | Movie title (max 100 chars) |
| `genre` | CharField | Genre category |
| `year` | Integer | Release year |
| `poster` | ImageField | S3/local poster image |
| `avg_rating` | Float | Computed average rating |
| `rating_count` | Integer | Number of ratings |

### UserProfile Model

```python
class UserProfile(models.Model):
    """Extended user profile - syncs with C engine via CSV"""
    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name='profile')
    c_user_id = models.IntegerField(unique=True, db_index=True)
    age = models.IntegerField(validators=[MinValueValidator(1), MaxValueValidator(120)])
    ratings_count = models.IntegerField(default=0)
    avg_rating_given = models.FloatField(default=0.0)
```

**Relationship**: One-to-one with Django's built-in `User` model.

### Rating Model

```python
class Rating(models.Model):
    """Rating model - syncs with C engine via CSV"""
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='ratings')
    movie = models.ForeignKey(Movie, on_delete=models.CASCADE, related_name='ratings')
    rating = models.FloatField(validators=[MinValueValidator(1.0), MaxValueValidator(5.0)])
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        unique_together = ('user', 'movie')  # Prevents duplicate ratings
        ordering = ['-created_at']
```

---

## Views

**Source File**: `movies/views.py`

### View Functions Overview

| View | URL | Auth Required | Description |
|------|-----|---------------|-------------|
| `home` | `/` | No | Landing page with featured movies |
| `movie_list` | `/movies/` | No | Browse all movies with search |
| `movie_detail` | `/movies/<id>/` | No | Movie details + rating form |
| `recommendations` | `/recommendations/` | Yes | Personalized recommendations |
| `my_ratings` | `/my-ratings/` | Yes | User's rating history |
| `register` | `/register/` | No | New user registration |
| `complete_profile` | `/complete-profile/` | Yes | Complete missing profile |

### Home View

```python
def home(request):
    """Landing page with featured movies"""
    movies = Movie.objects.all()[:10]
    return render(request, 'movies/home.html', {'movies': movies})
```

### Movie List View

```python
def movie_list(request):
    """Display all movies with search and genre filter"""
    query = request.GET.get('q', '')
    genre = request.GET.get('genre', '')
    
    movies = Movie.objects.all()
    
    if query:
        movies = movies.filter(
            Q(title__icontains=query) | Q(genre__icontains=query)
        )
    
    if genre:
        movies = movies.filter(genre=genre)
    
    genres = Movie.objects.values_list('genre', flat=True).distinct()
    
    return render(request, 'movies/movie_list.html', {
        'movies': movies,
        'genres': genres,
        'query': query,
        'selected_genre': genre
    })
```

**Features**:
- Full-text search on title and genre
- Genre filter dropdown
- Dynamic genre list extraction

### Movie Detail View

```python
def movie_detail(request, movie_id):
    """Movie detail and rating submission"""
    movie = get_object_or_404(Movie, movie_id=movie_id)
    user_rating = None
    
    if request.user.is_authenticated:
        user_rating = Rating.objects.filter(user=request.user, movie=movie).first()
    
    if request.method == 'POST' and request.user.is_authenticated:
        form = RatingForm(request.POST)
        if form.is_valid():
            rating_value = form.cleaned_data['rating']
            
            # Update or create rating
            Rating.objects.update_or_create(
                user=request.user,
                movie=movie,
                defaults={'rating': rating_value}
            )
            
            # Sync to C engine
            CSVSync.sync_all()
            engine = CRecommendationEngine()
            engine.add_rating(
                request.user.profile.c_user_id,
                movie.movie_id,
                rating_value
            )
            
            messages.success(request, 'Rating submitted successfully!')
            return redirect('movie_detail', movie_id=movie_id)
    
    # ... render template
```

**Rating Flow**:
1. Validate form input
2. Create/update Django Rating model
3. Sync all data to CSV files
4. Call C engine to update its runtime data
5. Display success message

### Recommendations View

```python
@login_required
def recommendations(request):
    """Get personalized recommendations from C engine"""
    try:
        # Ensure user has profile
        if not hasattr(request.user, 'profile'):
            return redirect('complete_profile')
        
        # Sync data to CSV for C engine
        CSVSync.sync_all()
        
        # Call C engine
        engine = CRecommendationEngine()
        recommended_movies = engine.get_recommendations(
            request.user.profile.c_user_id,
            count=10
        )
        
        # Enrich with Django model data (posters, etc.)
        for rec in recommended_movies:
            try:
                movie = Movie.objects.get(movie_id=rec['movie_id'])
                rec['movie_obj'] = movie
            except Movie.DoesNotExist:
                pass
        
        return render(request, 'movies/recommendations.html', {
            'recommendations': recommended_movies
        })
    except Exception as e:
        messages.error(request, f'Error: {e}')
        return render(request, 'movies/recommendations.html', {
            'recommendations': [], 'error': str(e)
        })
```

### Registration View

```python
def register(request):
    """User registration with profile creation"""
    if request.method == 'POST':
        user_form = UserCreationForm(request.POST)
        profile_form = UserProfileForm(request.POST)
        
        if user_form.is_valid() and profile_form.is_valid():
            user = user_form.save()
            
            # Create profile with auto-generated c_user_id
            profile = profile_form.save(commit=False)
            profile.user = user
            
            # Generate unique c_user_id
            max_id = UserProfile.objects.aggregate(max_id=Max('c_user_id'))['max_id']
            profile.c_user_id = (max_id or 100) + 1
            profile.save()
            
            # Sync to CSV
            CSVSync.export_users()
            
            login(request, user)
            return redirect('home')
    # ... render forms
```

---

## Forms

**Source File**: `movies/forms.py`

### Rating Form

```python
class RatingForm(forms.Form):
    RATING_CHOICES = [
        (1, '⭐ 1 - Poor'),
        (2, '⭐⭐ 2 - Fair'),
        (3, '⭐⭐⭐ 3 - Good'),
        (4, '⭐⭐⭐⭐ 4 - Very Good'),
        (5, '⭐⭐⭐⭐⭐ 5 - Excellent'),
    ]
    
    rating = forms.ChoiceField(
        choices=RATING_CHOICES,
        widget=forms.Select(attrs={'class': 'form-control'}),
        label='Your Rating (1-5)'
    )
```

### User Profile Form

```python
class UserProfileForm(forms.ModelForm):
    class Meta:
        model = UserProfile
        fields = ['age']
        widgets = {
            'age': forms.NumberInput(attrs={'class': 'form-control'})
        }
```

---

## URL Routing

**Source File**: `movies/urls.py`

```python
urlpatterns = [
    path('', views.home, name='home'),
    path('movies/', views.movie_list, name='movie_list'),
    path('movies/<int:movie_id>/', views.movie_detail, name='movie_detail'),
    path('recommendations/', views.recommendations, name='recommendations'),
    path('my-ratings/', views.my_ratings, name='my_ratings'),
    path('register/', views.register, name='register'),
    path('complete-profile/', views.complete_profile, name='complete_profile'),
]
```

**Project URLs** (`movie_site/urls.py`):
```python
urlpatterns = [
    path('admin/', admin.site.urls),
    path('accounts/', include('django.contrib.auth.urls')),  # Login/logout
    path('', include('movies.urls')),
]
```

---

## Admin Interface

**Source File**: `movies/admin.py`

### Movie Admin

```python
@admin.register(Movie)
class MovieAdmin(admin.ModelAdmin):
    list_display = ('movie_id', 'title', 'genre', 'year', 
                    'avg_rating', 'rating_count', 'poster_preview')
    list_filter = ('genre', 'year')
    search_fields = ('title', 'genre')
    ordering = ('title',)
    
    def poster_preview(self, obj):
        if obj.poster:
            return format_html('<img src="{}" width="50" height="75" />', obj.poster.url)
        return "No poster"
```

### User Profile Admin

```python
@admin.register(UserProfile)
class UserProfileAdmin(admin.ModelAdmin):
    list_display = ('c_user_id', 'user', 'age', 'ratings_count', 'avg_rating_given')
    search_fields = ('user__username', 'user__email')
    ordering = ('c_user_id',)
```

### Rating Admin

```python
@admin.register(Rating)
class RatingAdmin(admin.ModelAdmin):
    list_display = ('user', 'movie', 'rating', 'created_at')
    list_filter = ('rating', 'created_at')
    search_fields = ('user__username', 'movie__title')
    ordering = ('-created_at',)
```

---

## Templates

Located in `movies/templates/movies/`:

| Template | Description |
|----------|-------------|
| `base.html` | Base template with navbar, Bootstrap |
| `home.html` | Landing page |
| `movie_list.html` | Movie grid with search |
| `movie_detail.html` | Single movie with rating form |
| `recommendations.html` | Personalized recommendations |
| `my_ratings.html` | User's rating history |

Located in `movies/templates/registration/`:

| Template | Description |
|----------|-------------|
| `login.html` | Login form |
| `register.html` | Registration form |

---

## Authentication

### Configuration

```python
# settings.py
LOGIN_URL = 'login'
LOGIN_REDIRECT_URL = 'home'
LOGOUT_REDIRECT_URL = 'home'
```

### Protected Views

```python
from django.contrib.auth.decorators import login_required

@login_required
def recommendations(request):
    # Only authenticated users can access
    ...
```

### URLs (Built-in)
- `/accounts/login/` - Login page
- `/accounts/logout/` - Logout action
- `/accounts/password_change/` - Change password
- `/accounts/password_reset/` - Reset password

---

## Database Configuration

### Development (SQLite)
```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}
```

### Production (PostgreSQL)
```python
if os.environ.get('DATABASE_URL'):
    import dj_database_url
    DATABASES = {
        'default': dj_database_url.config(conn_max_age=600)
    }
```

---

## Static Files & Media

### Static Files (CSS, JS)
```python
STATIC_URL = 'static/'
STATIC_ROOT = BASE_DIR / 'staticfiles'
STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'
```

### Media Files (Posters)
```python
MEDIA_URL = '/media/'
MEDIA_ROOT = BASE_DIR / 'media'
```

### AWS S3 Configuration
```python
USE_S3 = os.environ.get('USE_S3', 'False') == 'True'

if USE_S3:
    AWS_ACCESS_KEY_ID = os.environ.get('AWS_ACCESS_KEY_ID')
    AWS_SECRET_ACCESS_KEY = os.environ.get('AWS_SECRET_ACCESS_KEY')
    AWS_STORAGE_BUCKET_NAME = os.environ.get('AWS_STORAGE_BUCKET_NAME')
    AWS_S3_CUSTOM_DOMAIN = f'{AWS_STORAGE_BUCKET_NAME}.s3.amazonaws.com'
    DEFAULT_FILE_STORAGE = 'storages.backends.s3boto3.S3Boto3Storage'
```

---

## Management Commands

### sync_csv
```bash
python manage.py sync_csv
```
Exports Django data to CSV files for C engine.

### import_movies
```bash
python manage.py import_movies
```
Imports movies from CSV to Django database.

### create_test_user
```bash
python manage.py create_test_user
```
Creates a test user with ratings for development.
